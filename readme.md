# Evaluating Fast VM Technics for Fuzzing.

## Instruction Set

There are five different types of instructions supported by the virtual machine.

| Instruction                      | Behavior                                                                                     |
|----------------------------------|----------------------------------------------------------------------------------------------|
| Terminals                        | Output strings to the buffer(Generated by grammar)                                                                |
| Non-terminals                    | Store the context into the calling stack; randomly choose a sub-program(sub-node in the grammar), and switch to it.(Generated by grammar) |
| Production Rules (expression)    | Store the context and push it into the calling stack; Switch to the program this production rule represents.(Generated by grammar) |
| RET                              | Pop the calling stack, re-store the program and IP                                           |
| HALT                             | Halt the virtual machine immediately                                                         |


## Threading Models 

### Direct Threading Model

In the direct threading model, each operation code directly points to its corresponding execution code. This means that when an opcode is executed, it jumps directly to the code that implements that operation.

The example of instruction Table:
``` Forth
' RET instructions 0 cells + ! 
' HALT instructions 1 cells + ! 
' func_5527066576 instructions 2 cells + ! 
' func_5527066704 instructions 3 cells + ! 
' func_5527066128 instructions 4 cells + ! 
' func_5527066400 instructions 5 cells + ! 
' func_5527066256 instructions 6 cells + ! 
' func_5527066192 instructions 7 cells + ! 
' func_5527067568 instructions 8 cells + ! 
' func_5527066896 instructions 9 cells + ! 
' func_5527067760 instructions 10 cells + ! 
' func_5527067984 instructions 11 cells + ! 
' func_5527068112 instructions 12 cells + ! 
' func_5527068304 instructions 13 cells + ! 
' func_5527068432 instructions 14 cells + ! 
' func_5527068560 instructions 15 cells + ! 
' func_5527068688 instructions 16 cells + ! 
' func_5527068240 instructions 17 cells + ! 
' func_5527069088 instructions 18 cells + ! 
' func_5527067264 instructions 19 cells + ! 
' func_5527067824 instructions 20 cells + ! 
' func_5527069408 instructions 21 cells + ! 
' func_5527066960 instructions 22 cells + ! 
' func_5527069536 instructions 23 cells + ! 
' func_5527069664 instructions 24 cells + ! 
' func_5527069824 instructions 25 cells + ! 
' func_5527070112 instructions 26 cells + ! 
' func_5527070240 instructions 27 cells + ! 
' func_5527070368 instructions 28 cells + ! 
' func_5527070496 instructions 29 cells + ! 
```

Example of terminal instrution
``` Forth
: func_5527070496 ( -- )
    47 extend-char
    NEXTI ;
```

Example of non-terminal instrution
``` Forth
create func_5527066128_op0 2 cells allot
22 func_5527066128_op0 0 cells + !
0 func_5527066128_op0 1 cells + !

create func_5527066128_op1 2 cells allot
5 func_5527066128_op1 0 cells + !
0 func_5527066128_op1 1 cells + !

: func_5527066128 ( -- )
    getdepth  maxdepth @ > if
        57 extend-char
        NEXTI
    else
        SAVE
        2 random
        case
            0 of
                func_5527066128_op0 ip ! endof
            1 of
                func_5527066128_op1 ip ! endof
        endcase
        SWITCH 
    endif ; 
```

Example of production rule
``` Forth
create exp_5527069088 4 cells allot
7 exp_5527069088 0 cells + !
19 exp_5527069088 1 cells + !
3 exp_5527069088 2 cells + !
0 exp_5527069088 3 cells + !
: func_5527069088 ( -- )
    getdepth  maxdepth @ > if
        57 extend-char 
        43 extend-char 
        57 extend-char 
        NEXTI
    else
    SAVE
    exp_5527069088 ip !
    SWITCH 
    endif ; 
```
The contol flow of the program is leaded by NETXI and SWITCH

``` Forth
: NEXTI ( -- )
    ip @ 1 cells + ip ! \ increment the instruction pointer 
    instructions ip @ @ cells + @ execute ;

: SWITCH ( -- )
    instructions ip @ @ cells + @ execute ;
```
The instruction pointer(IP) always indicate to the next instruction to be executed, to make sure the calling processing is Direct Threading Model as it may be impacted by the runtime of Forth, all instructions are generated with Continuation-Passing Style(CPS) so that making sure that Tail Call Optimization(TCO) enables if supported, **NEXTI** and **SWITCH** are always be called as the last statement.